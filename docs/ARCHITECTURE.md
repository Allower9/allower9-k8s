# ARCHITECTURE.md - ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Kubernetes Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° allower.ru

## ğŸ—ï¸ ĞĞ±Ñ‰Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
Ğ˜ĞĞ¢Ğ•Ğ ĞĞ•Ğ¢
   â†“ DNS: allower.ru â†’ 203.0.113.45
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LoadBalancer (External IP)                 â”‚
â”‚    ingress-nginx-controller Service                â”‚
â”‚         Port: 80 (HTTP) â†’ 443 (HTTPS)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     NGINX Ingress Controller (DaemonSet)           â”‚
â”‚  Reads Ingress rules, terminates TLS (HTTPSâ†’HTTP) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                      â†“               â†“
  Host: allower.ru (/)  Host: allower.ru (/api)  Other hosts
     â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚   â”‚   Backend    â”‚
â”‚   Service:80    â”‚   â”‚ Service:5000 â”‚
â”‚   (ClusterIP)   â”‚   â”‚ (ClusterIP)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                       â†“
  [nginx pod]          [busybox pod]
  [nginx pod]          [busybox pod]
  [nginx pod]          [busybox pod]
     â†“                       â†“
 PVC:frontend-data    PVC:backend-data
    3GB SSD              5GB SSD
```

---

## ğŸ”„ ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ https://allower.ru

1. **DNS resolution** (allower.ru â†’ 203.0.113.45)
2. **LoadBalancer** Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ HTTPS Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° port 443
3. **Ingress Controller** Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ingress resource:
   ```yaml
   host: allower.ru, path: /, â†’ Service: frontend:80
   ```
4. **Frontend Service** Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€ÑƒĞµÑ‚ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¼ĞµĞ¶Ğ´Ñƒ 3 nginx pods
5. **Nginx pod** Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ HTML Ñ UI

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: JavaScript Ğ´ĞµĞ»Ğ°ĞµÑ‚ fetch('/api/hello')

1. **Browser** Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° https://allower.ru/api/hello
2. **Ingress Controller** Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚:
   ```yaml
   host: allower.ru, path: /api â†’ Service: backend:5000
   ```
3. **Backend Service** Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸Ğ· 3 backend pods
4. **Backend pod** (busybox + netcat) Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ JSON
5. **Browser** Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚

---

## ğŸ” TLS/HTTPS Flow

```
Client                    Ingress Controller         Backend
  â”‚                              â”‚                       â”‚
  â”‚â”€â”€â”€â”€ HTTPS (TLS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                       â”‚
  â”‚                              â”‚ (Terminates TLS)      â”‚
  â”‚                              â”‚â”€â”€â”€ HTTP (plain) â”€â”€â”€â”€â”€â”€â†’
  â”‚                              â”‚ (internal, safe)      â”‚
  â”‚                        (Response)                     â”‚
  â”‚â†â”€â”€â”€ HTTPS (TLS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â†â”€â”€â”€ HTTP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

**Wichtig:** TLS Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ñ‚ client Ğ´Ğ¾ Ingress. Ğ’Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ° HTTP (safe, virtual network).

---

## ğŸ’¾ Persistent Data Architecture

### StorageClass vs PVC vs PV

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kubernetes Cluster (Node-1, Node-2, 3)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Pod                      PVC          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Frontendâ”‚â”€mountâ”€â”€â†’â”‚ frontend-â”‚     â”‚
â”‚  â”‚ (nginx) â”‚         â”‚  data    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ 3GB SSD  â”‚     â”‚
â”‚       â†“              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â”‚
â”‚    Node-1                 â†“           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                    â”‚ StorageClass â”‚   â”‚
â”‚                    â”‚yc-storage-ssd    â”‚
â”‚                    â”‚(provisioner) â”‚   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚         â”‚  CSI Driver         â”‚       â”‚
â”‚         â”‚ (Yandex Cloud)      â”‚       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Yandex Disk    â”‚
          â”‚  SSD Volume     â”‚
          â”‚  (Persistent!)  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PVC Creation Flow

```
1. Pod Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ
   â†“
2. Kubernetes Ğ²Ğ¸Ğ´Ğ¸Ñ‚ PVC: backend-data
   â†“
3. volumeBindingMode: WaitForFirstConsumer
   (Ğ¶Ğ´Ñ‘Ğ¼ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ consume'Ğ°)
   â†“
4. Pod Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ PVC
   â†“
5. CSI Driver ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Yandex Disk (5GB)
   â†“
6. PVC ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Bound
   â†“
7. Pod Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ/Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```

**Advantage:** Ğ”Ğ¸ÑĞº ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ³Ğ´Ğ° Ğ½ÑƒĞ¶ĞµĞ½ = ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¼ Ğ´ĞµĞ½ÑŒĞ³Ğ¸!

---

## ğŸ”€ Pod Anti-Affinity

### ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node-1     â”‚
â”‚ (iviq)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend pod  â”‚ kubernetes.io/hostname: iviq
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node-2     â”‚
â”‚ (ixyx)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend pod  â”‚ kubernetes.io/hostname: ixyx
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node-3     â”‚
â”‚ (ulaz)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend pod  â”‚ kubernetes.io/hostname: ulaz
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scheduler Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾:
  ĞĞµ ÑÑ‚Ğ°Ğ²ÑŒ 2 pod'Ğ° Ñ Ğ¼ĞµÑ‚ĞºĞ¾Ğ¹ app:backend Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½ hostname
```

### Ğ‘ĞµĞ· Anti-Affinity (Ğ¿Ğ»Ğ¾Ñ…Ğ¾)

```
Node-1: Backend-1, Backend-2, Backend-3
Node-2: (Ğ¿ÑƒÑÑ‚Ğ¾)
Node-3: (Ğ¿ÑƒÑÑ‚Ğ¾)

Ğ•ÑĞ»Ğ¸ Node-1 ÑƒĞ¿Ğ°Ğ´Ñ‘Ñ‚ â†’ Ğ²ÑĞµ Backend pods Ğ²Ğ½Ğ¸Ğ· âŒ
```

### Ğ¡ Anti-Affinity (Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾)

```
Node-1: Backend-1
Node-2: Backend-2
Node-3: Backend-3

Ğ•ÑĞ»Ğ¸ Node-1 ÑƒĞ¿Ğ°Ğ´Ñ‘Ñ‚ â†’ Backend-2,3 Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ âœ…
```

---

## ğŸ¯ Service Types

### 1. LoadBalancer (Ğ´Ğ»Ñ Ingress Controller)

```
External Internet
        â†“
   [203.0.113.45:80/443]
   LoadBalancer Service
   type: LoadBalancer
        â†“
   NGINX Controller Pods
```

**ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ IP** Ğ¾Ñ‚ Yandex Cloud

### 2. ClusterIP (Ğ´Ğ»Ñ Backend/Frontend)

```
Internal Cluster
   Ingress Controller
        â†“
   ClusterIP Service
   type: ClusterIP
   (10.96.X.X - internal only)
        â†“
   Backend/Frontend Pods
```

**Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹** (virtual) IP, Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ ÑĞ½Ğ°Ñ€ÑƒĞ¶Ğ¸

---

## ğŸ“Š ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Kubernetes Cluster (monitoring)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Node Exporter                      â”‚
â”‚  (DaemonSet Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ½Ğ¾Ğ´Ğµ)         â”‚
â”‚  â”œâ”€ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ CPU, Memory, Disk      â”‚
â”‚  â””â”€ Exposes :9100/metrics           â”‚
â”‚      â†“                              â”‚
â”‚  Prometheus                         â”‚
â”‚  (StatefulSet, 1 pod)               â”‚
â”‚  â”œâ”€ Scrapes metrics every 15s       â”‚
â”‚  â”œâ”€ Stores in PVC (10GB, 30 days)   â”‚
â”‚  â””â”€ Exposes :9090/api               â”‚
â”‚      â†“                              â”‚
â”‚  Grafana                            â”‚
â”‚  (Deployment, 1 pod)                â”‚
â”‚  â”œâ”€ Reads from Prometheus           â”‚
â”‚  â”œâ”€ Shows dashboards                â”‚
â”‚  â””â”€ Port 3000 (via Ingress)         â”‚
â”‚      â†“                              â”‚
â”‚  AlertManager                       â”‚
â”‚  (StatefulSet, 1 pod)               â”‚
â”‚  â””â”€ Sends alerts (Slack, Email)     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       Access via HTTPS
       grafana.allower.ru
```

---

## ğŸ” ELK Stack Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Kubernetes Nodes (3 ÑˆÑ‚)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  Filebeat DaemonSet (Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ½Ğ¾Ğ´Ğµ)             â”‚
â”‚  â””â”€ Reads /var/log/containers/*.log              â”‚
â”‚     â”œâ”€ Parses JSON logs                          â”‚
â”‚     â”œâ”€ Adds K8s metadata (pod, namespace)        â”‚
â”‚     â””â”€ Sends to Elasticsearch                    â”‚
â”‚          â†“                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  Elasticsearch (3 pods, StatefulSet)             â”‚
â”‚  â”œâ”€ Stores logs in indexes (logs-2025.10.31)     â”‚
â”‚  â”œâ”€ Replicas for HA                              â”‚
â”‚  â”œâ”€ PVC: 10GB SSD each                           â”‚
â”‚  â””â”€ Full-text search capabilities                â”‚
â”‚      â†“                                           â”‚
â”‚  Kibana (1 pod, Deployment)                      â”‚
â”‚  â”œâ”€ Web UI for searching logs                    â”‚
â”‚  â”œâ”€ Create dashboards                           â”‚
â”‚  â””â”€ Visualize metrics                            â”‚
â”‚                                                  â”‚
â”‚  Accessible via HTTPS: kibana.allower.ru        â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Deployment Flow

```
1. Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¿ÑƒÑˆĞ¸Ñ‚ ĞºĞ¾Ğ´ Ğ² GitHub
           â†“
2. CI/CD pipeline (GitLab CI / GitHub Actions)
   â”œâ”€ Build Docker image
   â”œâ”€ Push to registry
   â””â”€ Update k8s manifests (image tag)
           â†“
3. Git repo Ñ k8s ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°Ğ¼Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹
           â†“
4. ArgoCD watches Git repo
   â””â”€ Detects changes
           â†“
5. ArgoCD applies new manifests
   â””â”€ kubectl apply -f ...
           â†“
6. Kubernetes ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğµ pods
   â”œâ”€ Graceful shutdown ÑÑ‚Ğ°Ñ€Ñ‹Ñ…
   â”œâ”€ Health checks Ğ½Ğ¾Ğ²Ñ‹Ñ…
   â””â”€ Ğ¢Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğµ
           â†“
7. Prometheus Ğ¸ Grafana Ğ²Ğ¸Ğ´ÑÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
           â†“
8. Filebeat ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¸ Ğ¸Ğ· Ğ½Ğ¾Ğ²Ñ‹Ñ… pods
```

---

## ğŸ”„ High Availability (HA)

### Frontend HA

```
User Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ https://allower.ru

LoadBalancer Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚:
â”œâ”€ 33% Ğ½Ğ° Frontend pod-1 (Node-1)
â”œâ”€ 33% Ğ½Ğ° Frontend pod-2 (Node-2)
â””â”€ 33% Ğ½Ğ° Frontend pod-3 (Node-3)

Ğ•ÑĞ»Ğ¸ Node-1 ÑƒĞ¿Ğ°Ğ´Ñ‘Ñ‚:
â”œâ”€ Pod-1 dies
â”œâ”€ ĞĞ¾ Pod-2 Ğ¸ Pod-3 Ğ¶Ğ¸Ğ²Ñ‹
â”œâ”€ LoadBalancer Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ 100% Ñ‚Ñ€Ğ°Ñ„Ğ¸ĞºĞ° Ğ½Ğ° Ğ½Ğ¸Ñ…
â””â”€ Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼ âœ…
```

### Backend HA

```
ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Frontend:
â”œâ”€ 3 replicas Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹ Ğ¿Ğ¾ 3 Ğ½Ğ¾Ğ´Ğ°Ğ¼
â”œâ”€ Service Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€ÑƒĞµÑ‚ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº
â””â”€ Fault tolerance Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ½Ğ¾Ğ´Ñ‹
```

### Data Persistence HA

```
PVC backend-data (5GB)
â”œâ”€ Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ² Yandex Disk (Ğ²Ñ‹ÑĞ¾ĞºĞ°Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ)
â”œâ”€ Ğ ĞµĞ¿Ğ»Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
â””â”€ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ğ½Ğ¾Ğ´Ñ‹
```

---

## ğŸ“ Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ÑÑ…

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 1: Pod crashit

```
Backend pod dies
     â†“
Kubernetes Deployment ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€ Ğ²Ğ¸Ğ´Ğ¸Ñ‚
     â†“
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ pod
     â†“
New pod Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ
     â†“
Health checks Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚
     â†“
Service Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº
     â†“
Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼ âœ…
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 2: Node Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚

```
Node-1 Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ (hardware failure)
     â†“
Kubernetes Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Node offline
     â†“
Ğ’ÑĞµ pods Ğ½Ğ° Node-1 Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ÑÑ‚ Ğ² Failed
     â†“
Deployment ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğµ pods
     â†“
Anti-affinity â†’ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ½Ğ° Node-2, Node-3
     â†“
PVC Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğº Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ½Ğ¾Ğ´Ñƒ
     â†“
Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ âœ…
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 3: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

```
ĞĞ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°
     â†“
kubectl apply -f deployment.yaml (image: v2.0)
     â†“
Kubernetes ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ pod (v2.0)
     â†“
Health checks pass
     â†“
Service Ğ¿Ğ¾ÑÑ‚ĞµĞ¿ĞµĞ½Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº
     â†“
Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ pods v1.0 gracefully shutdown
     â†“
ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚ĞºĞ°Ñ‚ ĞµÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ ÑĞ»Ğ¾Ğ¼Ğ°Ğ»Ğ¾ÑÑŒ:
   kubectl rollout undo deployment/backend
```

---

## ğŸ“ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ğ¸

| ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ‚ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ |
|---------|-----------|--------|
| **Namespace** | Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ² | `default`, `monitoring`, `elk` |
| **Deployment** | Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ pods | `backend`, `frontend` |
| **Pod** | ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ | nginx, busybox |
| **Service** | Ğ‘Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¸ DNS | backend:5000 |
| **Ingress** | Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ + TLS | allower.ru â†’ frontend |
| **PVC** | Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ° | backend-data: 5GB |
| **PV** | Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ¸ÑĞº | Yandex Disk |
| **ConfigMap** | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸ + ĞºĞ¾Ğ´ | index.html, nginx.conf |
| **Secret** | Ğ§ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ | TLS ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ |
| **DaemonSet** | Pod Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ½Ğ¾Ğ´Ğµ | Filebeat, node-exporter |
| **StatefulSet** | Stateful Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ | Prometheus, Elasticsearch |

---

## âœ… Ğ˜Ñ‚Ğ¾Ğ³Ğ¾

Ğ­Ñ‚Ğ° Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚:
- **High Availability** - fault tolerance Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğµ Ğ½Ğ¾Ğ´
- **Scalability** - Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ replicas
- **Observability** - Prometheus + Grafana + ELK Stack
- **Security** - TLS/HTTPS, isolated namespaces
- **Data Persistence** - Yandex Disk + PVC
- **Cost Efficiency** - WaitForFirstConsumer Ğ´Ğ»Ñ PVC

